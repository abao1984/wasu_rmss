<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-cn" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/hsyw/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/hsyw/bootstrap/css/bootstrap-theme.min.css">
<script src="/hsyw/jquery-ui/jquery-1.10.2.js"></script>
<script src="/hsyw/bootstrap/js/bootstrap.min.js"></script>
<script>
$(function(){

	var url = document.URL;
	var query_dict = getQueryDict(url);
	//var id = query_dict['id'];
	$('#id_button_delete').click(function(){
		var id = $('#id_cmts_id').val();
		var post_dict = {};
		post_dict.id = id;
		$.post('/hsyw/ws.asmx/delete_cmts', post_dict)
		.done(function(result){
			var data = JSON.parse(result);
			if (data.result==='0')
			{
				alert('删除成功');
				var host =location.hostname;
				var port =location.port;
				var url = 'http://'+ host + ':' + port + '/hsyw/cmts/cmts_list.html?result=2';
				window.location = url;
			}
			else
			{
				alert('删除失败');
			}
			//$('#myModal').modal('hide');
		});
	});
	$('#id_button_save').click(function(){
		var id = $('#id_cmts_id').val();
		var device_code = $('#id_device_code').val();
		var belong_to = $('#id_belong_to').val();
		var room_id = $('#id_machine_room').val();
		var post_dict = {};
		post_dict.id = id;
		post_dict.device_code = device_code;
		post_dict.belong_to  = belong_to;
		post_dict.room_id = room_id;
		
		$.post('/hsyw/ws.asmx/edit_cmts',post_dict)
		.done(function(result){
		var data = JSON.parse(result);
		if (data.result === '0')
		{
			//alert ('保存成功');
			var host =location.hostname;
			var port =location.port;
			var url = 'http://'+ host + ':' + port + '/hsyw/cmts/cmts_list.html?result=1';
			window.location = url;
		}
		else
		{
			alert('保存失败：' + data.msg);
		}
		});
	});
	$.post('/hsyw/ws.asmx/get_cmts_detail', query_dict)
	.done(function(data){
		if (data!==null)
		{
			var dict = JSON.parse(data);
			var id  = dict['id'];
			var device_code = dict['device_code'];
			var belong_to  = dict['belong_to'];
			var room_id = dict['room_id'];
			$.post('/hsyw/ws.asmx/machine_room_detail',{id:room_id})
			.done(function(result){
				var json = JSON.parse(result);
				var room_id = json['mac_id'];
				var room_name = json['mac_name'];
				var value = '['+ room_id +']' + room_name;
				$('#id_room_name').val(value);
			});
			
			$('#id_cmts_id').val(id);
			$('#id_device_code').val(device_code);
			$('#id_belong_to').val(belong_to);
			$('#id_machine_room').val(room_id);
		}
		else
		{
			alert('取得数据时发生错误');
		}
	});
	function getQueryDict(url)
	{
		var query = url.split('?')[1];
		var params = query.split('&');
		var data_dict = {}
		for (var i=0;i<params.length;i++)
		{
			var data = params[i];
			var key = data.split('=')[0];
			var value = data.split('=')[1];
			data_dict[key] = value;
		}
		return data_dict;
	}
	
	$('#id_room_search').click(function(){
		var post_dict = {};
		var room_id = $('#id_room_id').val();
		post_dict['room_id'] = room_id;
		$('#search_field li').remove();
		$.post('/hsyw/ws.asmx/search_room_by_room_id', post_dict)
		.done(function(result){
			var json = JSON.parse(result);
			$.each(json,function(i,v){
				var id = v['ID'];
				var room_id = v['mac_id'];
				var name = v['mac_name'];
				var li_html = '<li class="list-group-item">'+
					'<div class="row">'+
					'<div class="col-md-1"><input type="radio" name="radio[]" data-id="'+ id +'"></div>'+
					'<div>['+ room_id +'] '+ name +'</div>'+
					'</div>'+
					'</li>';
				$('#search_field').append(li_html);
			});
		});
	});

	$('#id_button_select').click(function(){
		var object = $('input[type="radio"]:checked');
		if(object !== null)
		{
			var id = object.attr('data-id');
			var room_name = $(object.parent().parent()).text();
			$('#id_machine_room').val(id);
			$('#id_room_name').val(room_name);
			$('#roomModal').modal('hide');
		}
		
	});
	
});
</script>
</head>
<body>
<div class="container">
<div class="row">
<div class="col-xs-12">
<form id="form1" role="form">
<fieldset>
<div class="form-group">
<label for="id_cmts_id" class="sr-only">cmts_id</label>
<input type="hidden" id="id_cmts_id" name="id" value="">
</div>
<div class="form-group">
<label for="id_device_code">设备编码</label>
<input type="text" class="form-control" name="device_code" id="id_device_code">
</div>
<div class="form-group">
<label for="id_belong_to">所属分公司</label>
<input type="text" name="belong_to" class="form-control" id="id_belong_to">
</div>
<div class="form-group">
<label for="id_machine_room">所属机房</label>
<input type="hidden" name="room_id" id="id_machine_room" class="form-control">
<div class="input-group">
<input type="text" name="room_name" id="id_room_name" readonly="readonly" class="form-control">
<span class="input-group-btn">
<button type="button" class="btn btn-default" data-toggle="modal" data-target="#roomModal">选择</button>
</span>
</div>
</div>
</fieldset>
<hr>
<div class="form-group">
<button class="btn btn-danger" data-toggle="modal" data-target="#myModal" type="button" id="id_button_delete_confirm"><span class="glyphicon glyphicon-remove"></span> 删除</button>
<button class="btn btn-primary" type="button" id="id_button_save"><span class="glyphicon glyphicon-save"></span> 保存</button>
</div>
</form>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">
<span aria-hidden="true">&times;</span>
<span class="sr-only">close</span>
</button>
<h4>确定删除这条记录吗？</h4>
</div>
<div class="modal-body">
<p>
是否确定要删除这条记录？
</p>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
<button type="button" class="btn btn-primary" id="id_button_delete">确定</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="roomModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">
<span aria-hidden="true">&times;</span>
<span class="sr-only">close</span>
</button>
<h4>请选择所属机房...</h4>
</div>
<div class="modal-body">
<form role="form" class="form-inline">
<div class="form-group">
<label class="sr-only" for="id_room_id">room_id</label>
<input type="text" class="form-control" id="id_room_id" placeholder="请输入机房ID">
</div>
<button type="button" id="id_room_search" class="btn btn-info"><span class="glyphicon glyphicon-search"></span>
查询
</button>
<p></p>
<div id="search_field" class="list-group">
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
<button type="button" class="btn btn-primary" id="id_button_select">确定</button>
</div>
</div>
</div>
</div>

</div>
</div>
</div>
</body>
</html>
