<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-cn" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/hsyw/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/hsyw/bootstrap/css/bootstrap-theme.min.css">
<script src="/hsyw/jquery-ui/jquery-1.10.2.js"></script>
<script src="/hsyw/bootstrap/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="/hsyw/bootstrap/css/datepicker3.css">
<script src="/hsyw/bootstrap/js/bootstrap-datepicker.js"></script>
<script src="/hsyw/bootstrap/js/locales/bootstrap-datepicker.zh-CN.js" charset="UTF-8"></script>
<script>
$(function(){
	$.post('/hsyw/ws.asmx/get_last_config_bussiness_id')
	.done(function(result){
		var json = JSON.parse(result);
		var b_id = json['Bussiness_code'];
		$('#id_bussiness_code').val(parseInt(b_id)+1);
	});
	$('#id_save').click(function(){
		//var id=$('#id_id').val();
		
		var bussiness_code = $('#id_bussiness_code').val();
		if (bussiness_code.length===0)
		{
			return;
		}
		var device_info = $('#id_device_info').val();
		var client_name = $('#id_client_name').val();
		var config_date = $('#id_config_date').val();
		var config_person = $('#id_config_person').val();
		var line_code = $('#id_line_code').val();
		var device_type = $('#id_device_type').val();
		var room_id = $('#id_machine_room').val();
		var post_dict = {};
		//post_dict['id'] = id;
		post_dict['bussiness_code'] = bussiness_code;
		post_dict['device_info'] = device_info;
		post_dict['client_name'] = client_name;
		post_dict['config_person'] = config_person;
		post_dict['config_date'] = config_date;
		post_dict['line_code'] = line_code;
		post_dict['device_type'] = device_type;
		post_dict['room_id'] = room_id;
		
		$.post('/hsyw/ws.asmx/add_config',post_dict)
		.done(function(result){
			var json_obj = JSON.parse(result);
			if(json_obj['result']==='0')
			{
				var host =location.hostname;
				var port =location.port;
				var url = 'http://'+ host + ':' + port + '/hsyw/cmts/config_detail.html?id='+json_obj['id'];
				location.replace(url);
			}
			else{
				alert(json_obj['msg']);
			}
		});	
	});
	
	$('#id_delete_cmts').click(function(){
		var checked_checkboxes = $('input[type="checkbox"]:checked');
		var data_id_list =[];
		for (var i=0;i<checked_checkboxes.length;i++)
		{
			var node_id = $(checked_checkboxes[i]).attr('data-id');
			data_id_list.push(node_id);
		}
		var id_list = data_id_list.join(',');
		var post_data = {};
		post_data.id_list = id_list;
		$.post('/hsyw/ws.asmx/delete_cmts_list', post_data)
		.done(function(result){
			var data = JSON.parse(result);
			if (data.result ==='0')
			{
				alert ('删除成功');
				location.reload();
			}
			else
			{
				alert('操作失败：'+data.msg);
			}
			var res = searchData();
		});
	});
	
	//var bussiness_id = query_dict['id'];
	
	$('#id_add_cmts').click(function(){
		window.location='/hsyw/cmts/add_cmts.html';
	});

	$('#id_bussiness_code').change(function(){
		var bussiness_code = $('#id_bussiness_code').val();
		var post_dict ={};
		post_dict["bussiness_code"]= bussiness_code;
		$.post('/hsyw/ws.asmx/get_client_by_bussiness_code', post_dict)
		.done(function(result){
			var json_obj = JSON.parse(result);
			if (json_obj['result']==='0')
			{
				var client  = json_obj['client'];
				$('#id_client_helper').remove();
				$('#id_client_code').text(client.CUSTOMER_NO);
				$('#id_unit').text(client.DESCRIPTION);
				$('#id_address').text(client.ADDRESS);
				$('#id_client_sales').text(client.SALE_NAME);
				$('#id_contact_person').text(client.LINKMAN);
				$('#id_mobile').text(client.MOBILE_NO);
				$('#id_client_phone').text(client.PHONE_NO);
				$('#id_client_type').text(client.CUSTTYPE);
			}
			else
			{
				var help_html = '<span class="help-block" id="id_client_helper">没有找到相关客户信息</span>';
				$('#id_bussiness_code').parent().append(help_html);
			}
		});
	});
	$('.input-group.date').datepicker({
		format:'yyyy-mm-dd',
		todayBtn:'linked',
		language: 'zh-CN',
		autoclose:true,
		todayHighlight:true
	});
	$('#id_room_search').click(function(){
		var post_dict = {};
		var room_id = $('#id_room_id').val();
		post_dict['room_id'] = room_id;
		$('#search_field li').remove();
		$.post('/hsyw/ws.asmx/search_room_by_room_id', post_dict)
		.done(function(result){
			var json = JSON.parse(result);
			$.each(json,function(i,v){
				var id = v['ID'];
				var room_id = v['mac_id'];
				var name = v['mac_name'];
				var li_html = '<li class="list-group-item">'+
					'<div class="row">'+
					'<div class="col-md-1"><input type="radio" name="radio[]" data-id="'+ id +'"></div>'+
					'<div>['+ room_id +'] '+ name +'</div>'+
					'</div>'+
					'</li>';
				$('#search_field').append(li_html);
			});
		});
	});
	
	$('#id_button_select').click(function(){
		var object = $('input[type="radio"]:checked');
		if(object !== null)
		{
			var id = object.attr('data-id');
			var room_name = $(object.parent().parent()).text();
			$('#id_machine_room').val(id);
			$('#id_room_name').val(room_name);
			$('#roomModal').modal('hide');
		}
		
	});
});
</script>
</head>
<body>
<div class="container">
<div class="row">
<div class="col-xs-12">
<p></p>
<form role="form">
<div class="panel panel-primary">
<div class="panel-heading">
业务信息
<button class="btn btn-default btn-xs pull-right" type="button" id="id_save">保存</button>
</div>
<div class="panel-body">
<div class="form-group">
<label for="id_id" class="sr-only">id</label>
<input type="hidden" name="id" id="id_id">
</div>
<div class="form-group">
	<label for="id_bussiness_code">业务编码</label>
	<input  type="text" name="bussines_code" id="id_bussiness_code" class="form-control">
</div>
<div class="form-group">
	<label for="id_device_info">设备配置信息</label>
	<input type="text" name="device_info" id="id_device_info" class="form-control">
</div>
<div class="form-group">
	<label for="id_client_name">客户名称</label>
	<input type="text" name="client_name" id="id_client_name" class="form-control">
</div>
<div class="form-group">
	<label for="id_config_person">配置人</label>
	<input type="text" name="config_person" id="id_config_person" class="form-control">
</div>
<div class="form-group">
	<label for="id_config_date">配置时间</label>
	<div class="input-group date">
	<input type="text" name="config_date" id="id_config_date" class="form-control">
	<span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
	</div>
</div>
<div class="form-group">
	<label for="id_line_code">线路编码</label>
	<input type="text" name="line_code" id="id_line_code" class="form-control">
</div>
<div class="form-group">
	<label for="id_device_type">接入设备</label>
	<select class="form-control" name="device_type" id="id_device_type">
	<option value="EPON">EPON</option>
	<option value="光机">光机</option>
	<option value="CMTS">CMTS</option>
	</select>
</div>
<div class="form-group">
	<label for="id_room_name">机房</label>
	<input type="hidden" name="room_id" id="id_machine_room">
	<div class="input-group">
	<input class="form-control" type="text" readonly="readonly" name="room_name"  id="id_room_name" >
	<span class="input-group-btn">
	<button class="btn btn-default" type="button" data-toggle="modal" data-target="#roomModal">选择</button>
	</span>
	</div>
</div>
</div>
</div>

<div class="panel panel-info">
<div class="panel-heading">客户信息</div>
<div class="panel-body">
<dl class="dl-horizontal">
<dt >客户编号<dt>
<dd id="id_client_code"><dd>
<dt>用户类型<dt>
<dd id="id_client_type"><dd>
<dt >接入单位<dt>
<dd id="id_unit"><dd>
<dt>销售员<dt>
<dd id="id_client_sales"><dd>
<dt>用户负责人<dt>
<dd id="id_contact_person"><dd>
<dt>座机<dt>
<dd id="id_client_phone"><dd>
<dt>手机<dt>
<dd id="id_mobile"><dd>
<dt>Email<dt>
<dd id="id_email"><dd>
<dt>用户地址<dt>
<dd id="id_address"><dd>
</dl>
</div>
</div>

</form>



</div>

<div class="modal fade" id="roomModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">
<span aria-hidden="true">&times;</span>
<span class="sr-only">close</span>
</button>
<h4>请选择所属机房...</h4>
</div>
<div class="modal-body">
<form role="form" class="form-inline">
<div class="form-group">
<label class="sr-only" for="id_room_id">room_id</label>
<input type="text" class="form-control" id="id_room_id" placeholder="请输入机房ID">
</div>
<button type="button" id="id_room_search" class="btn btn-info"><span class="glyphicon glyphicon-search"></span>
查询
</button>
<p></p>
<div id="search_field" class="list-group">
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
<button type="button" class="btn btn-primary" id="id_button_select">确定</button>
</div>
</div>
</div>
</div>


</div>

</body>
</html>
